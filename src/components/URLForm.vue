<template>
  <form
    id="verify"
    name="website"
    :action="formAction"
    method="post"
    @submit.prevent="getVulnerabilityReport"
  >
    <label for="url" class="visually-hidden">Website URL:</label>
    <input
      type="url"
      v-model="url"
      name="url"
      id="url"
      placeholder="https://www.example.com"
      required
    />
    <div id="url-error" class="notification warning hidden"></div>

    <input type="submit" value="Test My Page" :disabled="!url" />
    <Loader v-if="processing" />
  </form>
</template>

<script>
import Loader from "./Loader.vue";

export default {
  name: "URLForm",
  components: {
    Loader
  },
  data() {
    return {
      formAction: "https://api.vulnerability-alerts.io/test",
      processing: false,
      showReport: false,
      url: ""
    };
  },
  methods: {
    getVulnerabilityReport() {
      const form = document.getElementById("verify");
      const formData = new URLSearchParams(new FormData(form)).toString();

      this.processing = true;

      fetch(this.formAction, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: formData
      })
        .then(response => {
          if (response.ok) {
            return response.json();
          }
        })
        .then(json => {
          this.processing = false;
          console.log(
            '["js-libraries"] count: ',
            json.audits["js-libraries"].details.items.length
          );
          console.log('["js-libraries"]', json.audits["js-libraries"].details);

          console.log(
            '["no-vulnerable-libraries"] score: ',
            json.audits["no-vulnerable-libraries"].score
          );
          console.log(
            '["no-vulnerable-libraries"]',
            json.audits["no-vulnerable-libraries"].details
          );
        })
        .catch(error => {
          console.error(
            `Error while getting vulnerability report: ${error.toString()}`
          );
        });
    }
  }
};
</script>

<style scoped lang="scss">
@import "../assets/sass/vars/media-queries";

input[type="url"] {
  width: 320px;
  font-size: 1.2rem;

  @media #{$mq-tablet-and-up} {
    width: 650px;
  }
}
</style>
