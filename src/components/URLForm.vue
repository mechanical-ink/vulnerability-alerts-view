<template>
  <div class="container">
    <form
      id="verify"
      name="website"
      :action="formAction"
      method="post"
      @submit.prevent="getVulnerabilityReport"
    >
      <label for="url" class="visually-hidden">Website URL:</label>
      <input
        type="url"
        v-model="url"
        name="url"
        id="url"
        placeholder="https://www.example.com"
        required
      />
      <div id="url-error" class="notification warning hidden"></div>

      <input type="submit" value="Test My Page" :disabled="!url" />
      <Loader v-if="processing" />
    </form>

    <VulnerabilityReport
      v-if="processing !== null && !processing"
      v-bind:showReport="showVulnerabilityReport"
      v-bind:report="vulnerabilityReport"
    />

    <DependencyReport
      v-if="processing !== null && !processing"
      v-bind:showReport="showDependencyReport"
      v-bind:report="dependencyReport"
    />
  </div>
</template>

<script>
import Loader from "./Loader.vue";
import DependencyReport from "./DependencyReport.vue";
import VulnerabilityReport from "./VulnerabilityReport.vue";

export default {
  name: "URLForm",
  components: {
    Loader,
    VulnerabilityReport,
    DependencyReport
  },
  data() {
    return {
      formAction: "https://api.vulnerability-alerts.io/test",
      processing: null,
      showDependencyReport: false,
      showVulnerabilityReport: false,
      dependencyReport: null,
      vulnerabilityReport: null,
      url: ""
    };
  },
  methods: {
    getVulnerabilityReport() {
      const form = document.getElementById("verify");
      const formData = new URLSearchParams(new FormData(form)).toString();

      this.showDependencyReport = false;
      this.showVulnerabilityReport = false;
      this.processing = true;

      fetch(this.formAction, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: formData
      })
        .then(response => {
          if (response.ok) {
            return response.json();
          }
        })
        .then(json => {
          this.processing = false;
          const dependencies = json.audits["js-libraries"].details;
          const dependenciesLength = dependencies.items.length;
          const vulnerabilities = json.audits["no-vulnerable-libraries"];
          const vulnerabilityScore = vulnerabilities.score;

          if (dependenciesLength > 0) {
            this.showDependencyReport = true;
            this.dependencyReport = dependencies;
          }

          if (vulnerabilityScore < 1) {
            this.showVulnerabilityReport = true;
            this.vulnerabilityReport = vulnerabilities.details;
          }
        })
        .catch(error => {
          console.error(
            `Error while getting vulnerability report: ${error.toString()}`
          );
        });
    }
  }
};
</script>

<style scoped lang="scss">
@import "../assets/sass/vars/media-queries";

input[type="url"] {
  width: 320px;
  font-size: 1.2rem;

  @media #{$mq-tablet-and-up} {
    width: 650px;
  }
}
</style>
